<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X√°c th·ª±c an to√†n - FASTRAFFIC</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #f0f2f5; }
        .box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 350px; }
        #status { color: #6c5ce7; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
        .cf-turnstile { margin: 25px 0; display: flex; justify-content: center; }
        #timer-box { display: none; font-size: 22px; color: #333; font-weight: bold; margin-top: 20px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6c5ce7; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="box">
    <div id="status">üîí X√°c th·ª±c b·∫°n l√† con ng∆∞·ªùi</div>
    
    <div class="cf-turnstile" 
         data-sitekey="0x4AAAAAACJ58mUD1xXb3uHV" 
         data-callback="onVerifySuccess"></div>

    <div id="timer-box">
        <div class="loader"></div>
        ‚è≥ Ch·ªù <span id="sec">5</span> gi√¢y...
    </div>
</div>

<script>
    // 1. C·∫•u h√¨nh Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        projectId: "fastraffic-8b585",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    // 2. L·∫•y link t·ª´ URL (ƒê√£ s·ª≠a l·ªói bi·∫øn decodedLink)
    const params = new URLSearchParams(window.location.search);
    const targetUrl = params.get("url"); 
    let decodedLink = "";

    if (targetUrl) {
        // G√°n ƒë√∫ng v√†o bi·∫øn decodedLink
        decodedLink = decodeURIComponent(targetUrl);
    } else {
        console.error("Kh√¥ng t√¨m th·∫•y link trong tham s·ªë url");
    }

    // 3. Khi x√°c th·ª±c Turnstile th√†nh c√¥ng
    function onVerifySuccess(token) {
        document.querySelector('.cf-turnstile').style.display = 'none';
        document.getElementById('timer-box').style.display = 'block';
        document.getElementById('status').innerText = "‚úÖ X√°c th·ª±c th√†nh c√¥ng";
        document.getElementById('status').style.color = "#27ae60";
        startCountdown();
    }

    // 4. H√†m ƒë·∫øm ng∆∞·ª£c chuy·ªÉn link
    function startCountdown() {
        let time = 5; 
        const secSpan = document.getElementById("sec");
        secSpan.innerText = time;

        const interval = setInterval(() => {
            time--;
            secSpan.innerText = time;

            if (time <= 0) {
                clearInterval(interval);
                // Ki·ªÉm tra bi·∫øn decodedLink ƒë√£ c√≥ d·ªØ li·ªáu ch∆∞a
                if (decodedLink && decodedLink !== "") {
                    window.location.href = decodedLink;
                } else {
                    alert("Kh√¥ng t√¨m th·∫•y link nhi·ªám v·ª•! Quay l·∫°i trang ch·ªß.");
                    window.location.href = "home.html";
                }
            }
        }, 1000);
    }

    // 5. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    firebase.auth().onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "index.html";
        }
    });
</script>
</body>
</html>
