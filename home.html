<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTRAFFIC - Hệ thống</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        
        /* User Info Bar */
        .user-bar { background: #fff; padding: 15px; margin-bottom: 5px; border-bottom: 1px solid #ddd; }
        .user-bar b { color: #2d3436; font-size: 15px; }
        .user-bar small { display: block; color: #636e72; margin-top: 4px; font-family: monospace; }

        /* Balance Card */
        .balance-card {
            background: linear-gradient(135deg, #0984e3, #6c5ce7);
            margin: 15px; padding: 25px; border-radius: 20px; color: #fff;
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
            position: relative; overflow: hidden;
        }
        .balance-card::after {
            content: ""; position: absolute; right: -20px; bottom: -20px;
            width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;
        }
        .balance-label { font-size: 14px; opacity: 0.9; }
        .balance-val { font-size: 32px; font-weight: 800; margin: 10px 0; display: block; }

        /* Accordion Style cho Nhiệm vụ */
        .task-group-header {
            background: #fff; padding: 15px; margin-top: 10px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border: 1px solid #eee; transition: 0.3s;
        }
        .task-group-header:active { background: #f1f2f6; }
        .task-group-header i.arrow { transition: 0.3s; }
        .task-group-header.active i.arrow { transform: rotate(180deg); }

        .task-list-content {
            display: none; padding: 5px 10px; background: #fafafa;
            border-radius: 0 0 12px 12px; border: 1px solid #eee; border-top: none;
        }
        .task-list-content.show { display: block; animation: slideDown 0.3s ease-out; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card { background: #fff; margin: 15px; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; font-size: 18px; color: #2d3436; border-left: 4px solid #e74c3c; padding-left: 10px; }
        
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .task-item:last-child { border-bottom: none; }
        
        .btn-do { background: #e74c3c; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* Navigation */
        .nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #eee; height: 65px; z-index: 9999; }
        .nav-link { flex: 1; text-align: center; padding-top: 12px; font-size: 12px; color: #b2bec3; cursor: pointer; }
        .nav-link.active { color: #e74c3c; font-weight: bold; }
        .nav-link i { display: block; font-size: 22px; margin-bottom: 3px; }

        .tab-box { display: none; }
        .tab-box.active { display: block; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #dfe6e9; border-radius: 10px; box-sizing: border-box; }
        .status-pending { color: #fdcb6e; font-weight: bold; }
        .status-success { color: #00b894; font-weight: bold; }
        .status-rejected { color: #d63031; font-weight: bold; }
    </style>
</head>
<body>

<div id="tab-home" class="tab-box active">
    <div class="user-bar">
        Xin chào: <b id="u-mail">...</b>
        <small>UID: <span id="u-uid">...</span></small>
    </div>

    <div class="balance-card">
        <span class="balance-label"><i class="fas fa-wallet"></i> Số dư khả dụng</span>
        <span class="balance-val" id="u-balance">0đ</span>
    </div>

    <div class="card">
        <h3>Danh sách nhiệm vụ</h3>
        <div id="render-tasks">Đang tải...</div>
    </div>
</div>

<div id="tab-history" class="tab-box">
    <div class="card"><h3>Lịch sử hoạt động</h3><div id="render-history">...</div></div>
</div>
<div id="tab-rules" class="tab-box">
    <div class="card"><h3>Quy định</h3><ul><li>Không cheat.</li><li>Min rút 20k.</li></ul></div>
</div>
<div id="tab-withdraw" class="tab-box">
    <div class="card">
        <h3>Rút tiền</h3>
        <input type="number" id="w-amount" placeholder="Số tiền">
        <input type="text" id="w-info" placeholder="Thông tin STK">
        <button class="btn-do" style="width:100%; background:#0984e3" onclick="handleWithdraw()">RÚT TIỀN</button>
    </div>
    <div class="card"><h3>Lịch sử rút</h3><div id="render-withdraw-history">...</div></div>
</div>

<nav class="nav">
    <div class="nav-link active" onclick="goTab('tab-home', this)"><i class="fas fa-home"></i>Home</div>
    <div class="nav-link" onclick="goTab('tab-history', this)"><i class="fas fa-tasks"></i>Lịch sử</div>
    <div class="nav-link" onclick="goTab('tab-rules', this)"><i class="fas fa-info-circle"></i>Quy định</div>
    <div class="nav-link" onclick="goTab('tab-withdraw', this)"><i class="fas fa-wallet"></i>Rút tiền</div>
</nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fastraffic-8b585"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function goTab(tabId, element) {
        document.querySelectorAll('.tab-box').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        element.classList.add('active');
    }

    // Hàm đóng mở tab nhiệm vụ
    function toggleGroup(id, el) {
        const content = document.getElementById(id);
        content.classList.toggle('show');
        el.classList.toggle('active');
    }

    firebase.auth().onAuthStateChanged(user => {
        if (!user) { window.location.href = "index.html"; return; }
        const uid = user.uid;
        document.getElementById("u-mail").innerText = user.email;
        document.getElementById("u-uid").innerText = uid;

        db.ref("users/" + uid + "/money").on("value", s => {
            document.getElementById("u-balance").innerText = (s.val() || 0).toLocaleString() + "đ";
        });

        db.ref("Task").on("value", snap => {
            const div = document.getElementById("render-tasks");
            div.innerHTML = "";
            snap.forEach(group => {
                const name = group.key;
                let bonus = (name === "Traffictot") ? 400 : (name === "Click1s" ? 600 : 500);
                const contentId = 'content-' + name;

                let html = `
                    <div class="task-group-header" onclick="toggleGroup('${contentId}', this)">
                        <span><i class="fas fa-list-alt"></i> <b>${name}</b> (+${bonus}đ)</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </div>
                    <div id="${contentId}" class="task-list-content">`;
                
                group.forEach(task => {
                    const data = task.val();
                    const link = (typeof data === 'object') ? data.link : data;
                    html += `
                        <div class="task-item">
                            <span>Nhiệm vụ #${task.key}</span>
                            <button class="btn-do" onclick="doTask('${name}', '${link}', ${bonus})">Làm</button>
                        </div>`;
                });
                html += `</div>`;
                div.innerHTML += html;
            });
        });

        // Load Lịch sử (giữ nguyên logic của bạn)
        db.ref("history/" + uid).on("value", s => {
            let h = ""; let w = "";
            s.forEach(c => {
                const d = c.val();
                const statusLbl = d.status === "pending" ? "Đang duyệt" : (d.status === "success" ? "Thành công" : "Bị từ chối");
                if (d.amount < 0) {
                    w = `<div class="task-item"><div><b>Rút ${Math.abs(d.amount).toLocaleString()}đ</b><br><small>${d.time}</small></div><div class="status-${d.status}">${statusLbl}</div></div>` + w;
                } else {
                    h = `<div class="task-item"><div><b>${d.task}</b><br><small>${d.time}</small></div><div class="status-${d.status}">${statusLbl}</div></div>` + h;
                }
            });
            document.getElementById("render-history").innerHTML = h || "Trống.";
            document.getElementById("render-withdraw-history").innerHTML = w || "Trống.";
        });
    });

    function doTask(name, link, bonus) {
        window.open(link, "_blank");
        db.ref("history/" + firebase.auth().currentUser.uid + "/" + Date.now()).set({
            task: name, amount: bonus, status: "pending", time: new Date().toLocaleString()
        });
    }

    function handleWithdraw() {
        const amt = parseInt(document.getElementById("w-amount").value);
        const info = document.getElementById("w-info").value;
        const uid = firebase.auth().currentUser.uid;
        if (amt < 20000 || !info) return alert("Min 20k!");
        db.ref("users/" + uid + "/money").once("value", s => {
            const cur = s.val() || 0;
            if (cur < amt) return alert("Không đủ tiền!");
            db.ref("users/" + uid + "/money").set(cur - amt).then(() => {
                db.ref("history/" + uid + "/" + Date.now()).set({
                    task: "Rút tiền: " + info, amount: -amt, status: "pending", time: new Date().toLocaleString()
                });
                alert("Đã gửi yêu cầu!");
            });
        });
    }
</script>
</body>
</html>
