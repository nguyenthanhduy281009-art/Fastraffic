<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTRAFFIC - Trang chủ</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        .header { background: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .balance-card { background: white; margin: 15px; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .balance-amount { font-size: 28px; color: #2ecc71; font-weight: bold; margin: 10px 0; }
        
        /* Menu điều hướng */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1000; }
        .nav-item { text-align: center; color: #666; text-decoration: none; font-size: 12px; flex: 1; border: none; background: none; cursor: pointer; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: #e94560; }

        .content-section { padding: 15px; display: none; }
        .content-section.active { display: block; }
        
        /* Style cho Form Rút tiền */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-withdraw { width: 100%; padding: 12px; background: #e94560; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        .status-done { color: #27ae60; font-weight: bold; }
        .status-pending { color: #f39c12; font-weight: bold; }
        .status-cancelled { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header"><h2 style="margin:0; color:#e94560;">FASTRAFFIC</h2></div>

    <div id="home" class="content-section active">
        <div class="balance-card">
            <p style="margin:0; color:#666;">Số dư hiện tại</p>
            <div class="balance-amount" id="user-money">0đ</div>
        </div>
        <div style="padding:15px; background:white; border-radius:10px; margin-top:10px;">
            <p><b>Thông báo:</b> Hệ thống đang hoạt động ổn định. Chúc bạn một ngày làm việc hiệu quả!</p>
        </div>
    </div>

    <div id="history" class="content-section">
        <h3><i class="fas fa-history"></i> Lịch sử giao dịch</h3>
        <table>
            <thead><tr><th>Thời gian</th><th>Số tiền</th><th>Trạng thái</th></tr></thead>
            <tbody id="history-list"></tbody>
        </table>
    </div>

    <div id="rules" class="content-section">
        <h3><i class="fas fa-book"></i> Quy định</h3>
        <div style="background:white; padding:15px; border-radius:10px; line-height: 1.6;">
            <p>1. Rút tiền tối thiểu: <b>20.000đ</b>.</p>
            <p>2. Thời gian duyệt: 5 phút - 24 giờ.</p>
            <p>3. Tuyệt đối không gian lận dưới mọi hình thức.</p>
        </div>
    </div>

    <div id="withdraw" class="content-section">
        <h3><i class="fas fa-wallet"></i> Rút tiền</h3>
        <div class="balance-card" style="margin:0 0 15px 0; padding:10px;">
            Số dư khả dụng: <b id="withdraw-balance" style="color:#2ecc71;">0đ</b>
        </div>
        <div style="background:white; padding:20px; border-radius:15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <div class="form-group">
                <label>Ngân hàng / Ví</label>
                <select id="bank-name">
                    <option value="MBBank">MBBank</option>
                    <option value="Momo">Momo</option>
                    <option value="Vietcombank">Vietcombank</option>
                    <option value="Agribank">Agribank</option>
                </select>
            </div>
            <div class="form-group">
                <label>Số tài khoản / Số điện thoại</label>
                <input type="text" id="bank-acc" placeholder="Nhập số tài khoản nhận tiền">
            </div>
            <div class="form-group">
                <label>Số tiền rút (VNĐ)</label>
                <input type="number" id="withdraw-amount" placeholder="Tối thiểu 20.000">
            </div>
            <button class="btn-withdraw" onclick="requestWithdraw()">GỬI YÊU CẦU RÚT TIỀN</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="showTab('home', this)"><i class="fas fa-home"></i>Trang chủ</button>
        <button class="nav-item" onclick="showTab('history', this)"><i class="fas fa-history"></i>Lịch sử</button>
        <button class="nav-item" onclick="showTab('rules', this)"><i class="fas fa-book"></i>Quy định</button>
        <button class="nav-item" onclick="showTab('withdraw', this)"><i class="fas fa-wallet"></i>Rút tiền</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        projectId: "fastraffic-8b585",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function showTab(tabId, el) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        el.classList.add('active');
    }

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            const uid = user.email.replace(/\./g, '_');
            // Cập nhật số dư realtime
            db.ref(`users/${uid}/money`).on('value', s => {
                const val = (s.val() || 0);
                document.getElementById('user-money').innerText = val.toLocaleString() + "đ";
                document.getElementById('withdraw-balance').innerText = val.toLocaleString() + "đ";
            });
            // Cập nhật lịch sử realtime
            db.ref(`history/${uid}`).on('value', s => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                if(s.exists()){
                    Object.values(s.val()).reverse().forEach(item => {
                        let st = item.status === 'done' ? 'Thành công' : (item.status === 'pending' ? 'Chờ duyệt' : 'Đã hủy');
                        list.innerHTML += `<tr><td><small>${item.time||''}</small></td><td>${item.amount.toLocaleString()}đ</td><td class="status-${item.status}">${st}</td></tr>`;
                    });
                }
            });
        } else { location.href = 'login.html'; }
    });

    // HÀM GỬI YÊU CẦU RÚT TIỀN
    function requestWithdraw() {
        const user = firebase.auth().currentUser;
        const uid = user.email.replace(/\./g, '_');
        const bank = document.getElementById('bank-name').value;
        const acc = document.getElementById('bank-acc').value;
        const amt = parseInt(document.getElementById('withdraw-amount').value);

        db.ref(`users/${uid}/money`).once('value', s => {
            const current = s.val() || 0;
            if(!acc || !amt) return alert("Vui lòng nhập đầy đủ!");
            if(amt < 20000) return alert("Rút tối thiểu 20.000đ!");
            if(amt > current) return alert("Số dư không đủ!");

            const time = new Date().toLocaleString();
            const wId = "WD" + Date.now();

            // 1. Lưu vào danh sách chờ duyệt cho Admin
            db.ref(`withdraw_requests/${wId}`).set({
                userId: uid, bankName: bank, bankAcc: acc, amount: amt, status: 'pending', time: time
            });

            // 2. Lưu vào lịch sử người dùng để hiện "Chờ duyệt"
            db.ref(`history/${uid}/${wId}`).set({
                amount: -amt, status: 'pending', time: time, withdrawId: wId
            }).then(() => {
                alert("Đã gửi yêu cầu! Vui lòng chờ duyệt.");
                document.getElementById('bank-acc').value = "";
                document.getElementById('withdraw-amount').value = "";
                showTab('history', document.querySelectorAll('.nav-item')[1]);
            });
        });
    }
</script>
</body>
</html>
