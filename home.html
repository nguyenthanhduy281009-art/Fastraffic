<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Fastraffic - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; background: #f4f7f6; color: #333; }
        .sidebar { width: 250px; background: #fff; height: 100vh; border-right: 1px solid #ddd; position: fixed; }
        .sidebar-header { padding: 25px; font-weight: bold; color: #e94560; font-size: 22px; text-align: center; border-bottom: 1px solid #eee; }
        .menu-item { padding: 15px 20px; display: flex; align-items: center; color: #333; cursor: pointer; transition: 0.2s; }
        .menu-item:hover { background: #f9f9f9; }
        .menu-item.active { background: #fff5f6; color: #e94560; border-left: 4px solid #e94560; }
        .main { margin-left: 250px; flex: 1; min-height: 100vh; }
        .top-bar { background: #fff; padding: 15px 25px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 30px; }
        .logout { background: #ff4d4d; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .money-card { background: linear-gradient(135deg, #e94560, #ff6b81); color: white; padding: 25px; border-radius: 15px; display: inline-block; min-width: 280px; box-shadow: 0 8px 16px rgba(233, 69, 96, 0.2); margin-bottom: 30px; }
        #userMoney { font-size: 32px; font-weight: bold; margin-top: 5px; }
        .task-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .task-card { background: white; border-radius: 12px; padding: 20px; border: 1px dashed #ccc; transition: 0.3s; }
        .btn-do { width: 100%; padding: 12px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; margin: 15px 0; font-size: 14px; }
        .task-info { display: flex; justify-content: space-around; border-top: 1px solid #eee; padding-top: 12px; font-size: 11px; text-align: center; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
        th { background: #f8f9fa; color: #666; font-size: 13px; }
        .withdraw-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">FASTRAFFIC</div>
    <div id="m-trangchu" class="menu-item" onclick="showPage('trangchu')"><i class="fas fa-home" style="margin-right:10px"></i> Trang chủ</div>
    <div id="m-lichsu" class="menu-item" onclick="showPage('lichsu')"><i class="fas fa-history" style="margin-right:10px"></i> Lịch sử</div>
    <div id="m-quydinh" class="menu-item" onclick="showPage('quydinh')"><i class="fas fa-gavel" style="margin-right:10px"></i> Quy định</div>
    <div id="m-ruttien" class="menu-item" onclick="showPage('ruttien')"><i class="fas fa-wallet" style="margin-right:10px"></i> Rút tiền</div>
</div>

<div class="main">
    <div class="top-bar">
        <span>Chào, <b id="userMail" style="color:#e94560">Đang tải...</b></span>
        <button class="logout" onclick="logout()">Đăng xuất</button>
    </div>
    <div class="content" id="view"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        projectId: "fastraffic-8b585",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUserId = "";
    let currentBalance = 0;

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // Đồng nhất ID người dùng bằng cách thay dấu '.' thành '_' như trong Realtime Database của bạn
            currentUserId = user.email.replace(/\./g, '_');
            document.getElementById("userMail").innerText = user.email;
            checkDailyReset();
            showPage('trangchu'); 
        } else { window.location.href = "index.html"; }
    });

    function checkDailyReset() {
        const today = new Date().toLocaleDateString();
        if (localStorage.getItem('last_date') !== today) {
            localStorage.setItem('done_tasks', '[]');
            localStorage.setItem('last_date', today);
        }
    }

    function showPage(page) {
        const view = document.getElementById("view");
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        const activeMenu = document.getElementById('m-' + page);
        if(activeMenu) activeMenu.classList.add('active');

        if (page === 'trangchu') {
            view.innerHTML = `
                <div class="money-card"><div id="userMoney">0 VNĐ</div></div>
                <h3 style="color:#e94560">Hệ thống Traffictot</h3>
                <div id="list-traffictot" class="task-container">Đang tải...</div>
                <h3 style="color:#28a745">Hệ thống Click1s</h3>
                <div id="list-click1s" class="task-container">Đang tải...</div>`;
            loadMoney(); renderTasks();
        } 
        else if (page === 'lichsu') {
            view.innerHTML = `<h2>Lịch sử chờ duyệt</h2><div id="historyData">Đang tải...</div>`;
            loadHistory();
        }
        else if (page === 'quydinh') {
            view.innerHTML = `<h2>Quy định</h2><div style="background:white; padding:20px; border-radius:15px;"><p>Vượt link và lấy mã chính xác để được duyệt tiền.</p></div>`;
        }
        else if (page === 'ruttien') {
            view.innerHTML = `
                <h2>Rút tiền</h2>
                <div style="background:white; padding:25px; border-radius:15px; max-width:500px; box-shadow:0 4px 10px rgba(0,0,0,0.05)">
                    <p>Số dư khả dụng: <b id="drawBalance" style="color:#e94560">0 VNĐ</b></p>
                    <input type="number" id="amount" class="withdraw-input" placeholder="Số tiền rút (Tối thiểu 50.000)">
                    <textarea id="bankInfo" class="withdraw-input" rows="3" placeholder="Ngân hàng - STK - Tên chủ thẻ"></textarea>
                    <button onclick="requestWithdraw()" class="btn-do" style="background:#e94560">Gửi yêu cầu rút</button>
                </div>`;
            loadMoney();
        }
    }

    function loadMoney() {
        // Lấy tiền trực tiếp từ nhánh users/ID_nguoi_dung
        db.ref('users/' + currentUserId).on('value', (s) => {
            currentBalance = s.val() ? s.val().money : 0;
            const moneyStr = currentBalance.toLocaleString() + " VNĐ";
            if(document.getElementById("userMoney")) document.getElementById("userMoney").innerText = moneyStr;
            if(document.getElementById("drawBalance")) document.getElementById("drawBalance").innerText = moneyStr;
        });
    }

    function renderTasks() {
        const doneTasks = JSON.parse(localStorage.getItem('done_tasks') || '[]');
        
        // Load nhiệm vụ Traffictot - Bạn có thể sửa tiền thưởng 250 tại đây
        db.ref('Task/Traffictot').on('value', (s) => {
            let h = ''; const d = s.val();
            if(d) Object.keys(d).forEach(k => {
                if (!doneTasks.includes('Traffictot_' + k)) h += createTaskUI('Traffictot', k, d[k], 250, '#e94560');
            });
            document.getElementById('list-traffictot').innerHTML = h || 'Hết nhiệm vụ.';
        });

        // Load nhiệm vụ Click1s - Bạn có thể sửa tiền thưởng 500 tại đây
        db.ref('Task/Click1s').on('value', (s) => {
            let h = ''; const d = s.val();
            if(d) Object.keys(d).forEach(k => {
                if (!doneTasks.includes('Click1s_' + k)) h += createTaskUI('Click1s', k, d[k], 500, '#28a745');
            });
            document.getElementById('list-click1s').innerHTML = h || 'Hết nhiệm vụ.';
        });
    }

    function createTaskUI(sys, id, url, cash, col) {
        return `
            <div class="task-card" style="border-color:${col}" id="card_${sys}_${id}">
                <div style="font-weight:bold; color:${col}">${sys}</div>
                <button class="btn-do" style="background:${col}" onclick="goTask('${url}','${sys}','${id}',${cash})">Thực hiện</button>
                <div class="task-info">
                    <div><b>${cash.toLocaleString()}đ</b><br>Tiền</div>
                    <div style="color:green"><b>Sẵn sàng</b></div>
                </div>
            </div>`;
    }

    function goTask(url, sys, id, amt) {
        const doneTasks = JSON.parse(localStorage.getItem('done_tasks') || '[]');
        doneTasks.push(sys + '_' + id);
        localStorage.setItem('done_tasks', JSON.stringify(doneTasks));
        
        db.ref('history/' + currentUserId + '/' + Date.now()).set({
            task: sys + " - " + id, 
            amount: amt, 
            status: "pending", 
            time: new Date().toLocaleString('vi-VN')
        }).then(() => {
            document.getElementById(`card_${sys}_${id}`).style.display = 'none';
            window.open(`wait.html?target=${btoa(url)}`, '_blank');
        });
    }

    function requestWithdraw() {
        const amt = parseInt(document.getElementById('amount').value);
        const info = document.getElementById('bankInfo').value;
        if(amt < 50000 || !info) return alert("Vui lòng nhập đầy đủ và số tiền tối thiểu 50.000đ!");
        if(amt > currentBalance) return alert("Số dư khả dụng không đủ!");

        db.ref('withdraw_requests/' + Date.now()).set({
            userId: currentUserId,
            amount: amt,
            info: info,
            status: "pending",
            time: new Date().toLocaleString('vi-VN')
        }).then(() => {
            alert("Đã gửi yêu cầu rút tiền thành công!");
            document.getElementById('amount').value = '';
            document.getElementById('bankInfo').value = '';
        });
    }

    function loadHistory() {
        db.ref('history/' + currentUserId).on('value', (s) => {
            let h = `<table><tr><th>Nhiệm vụ</th><th>Thời gian</th><th>Tiền</th><th>Trạng thái</th></tr>`;
            const d = s.val();
            if(d) Object.values(d).reverse().forEach(i => {
                let st = i.status === 'pending' ? '<span style="color:orange">Chờ duyệt</span>' : '<span style="color:green">Đã cộng</span>';
                h += `<tr><td>${i.task}</td><td>${i.time}</td><td>+${i.amount}</td><td>${st}</td></tr>`;
            });
            document.getElementById("historyData").innerHTML = h + `</table>`;
        });
    }

    function logout() { firebase.auth().signOut().then(() => window.location.href = "index.html"); }
</script>
</body>
</html>
