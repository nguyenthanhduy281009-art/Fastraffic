<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTRAFFIC - Hệ thống</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        
        /* User Info Bar */
        .user-bar { background: #fff; padding: 15px; margin-bottom: 5px; border-bottom: 1px solid #ddd; }
        .user-bar b { color: #2d3436; font-size: 15px; }
        .user-bar small { display: block; color: #636e72; margin-top: 4px; font-family: monospace; }

        /* Balance Card Gradient */
        .balance-card {
            background: linear-gradient(135deg, #0984e3, #6c5ce7);
            margin: 15px; padding: 25px; border-radius: 20px; color: #fff;
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
            position: relative; overflow: hidden;
        }
        .balance-card::after {
            content: ""; position: absolute; right: -20px; bottom: -20px;
            width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;
        }
        .balance-label { font-size: 14px; opacity: 0.9; }
        .balance-val { font-size: 32px; font-weight: 800; margin: 10px 0; display: block; }

        /* Task & Card Style */
        .card { background: #fff; margin: 15px; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; font-size: 18px; color: #2d3436; border-left: 4px solid #e74c3c; padding-left: 10px; }
        
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .task-item:last-child { border-bottom: none; }
        .btn-do { background: #e74c3c; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-do:active { transform: scale(0.95); opacity: 0.8; }

        /* Navigation */
        .nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #eee; height: 65px; z-index: 9999; }
        .nav-link { flex: 1; text-align: center; padding-top: 12px; font-size: 12px; color: #b2bec3; cursor: pointer; }
        .nav-link.active { color: #e74c3c; font-weight: bold; }
        .nav-link i { display: block; font-size: 22px; margin-bottom: 3px; }

        .tab-box { display: none; }
        .tab-box.active { display: block; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #dfe6e9; border-radius: 10px; box-sizing: border-box; font-size: 15px; }
        .status-pending { color: #fdcb6e; font-weight: bold; }
        .status-success { color: #00b894; font-weight: bold; }
        .status-rejected { color: #d63031; font-weight: bold; }
    </style>
</head>
<body>

<div id="tab-home" class="tab-box active">
    <div class="user-bar">
        Xin chào: <b id="u-mail">...</b>
        <small>UID: <span id="u-uid">...</span></small>
    </div>

    <div class="balance-card">
        <span class="balance-label"><i class="fas fa-wallet"></i> Số dư khả dụng</span>
        <span class="balance-val" id="u-balance">0đ</span>
        <small style="opacity: 0.7; font-size: 11px;">Hệ thống bảo mật FASTRAFFIC</small>
    </div>

    <div class="card">
        <h3>Nhiệm vụ khả dụng</h3>
        <div id="render-tasks">Đang tải dữ liệu...</div>
    </div>
</div>

<div id="tab-history" class="tab-box">
    <div class="card">
        <h3>Lịch sử hoạt động</h3>
        <div id="render-history">Chưa có hoạt động nào.</div>
    </div>
</div>

<div id="tab-rules" class="tab-box">
    <div class="card">
        <h3>Quy định sử dụng</h3>
        <ul style="padding-left: 20px; line-height: 2; color: #636e72;">
            <li>Không sử dụng công cụ auto, giả lập.</li>
            <li>Rút tiền tối thiểu từ 20.000đ.</li>
            <li>Duyệt rút tiền từ 24h - 48h.</li>
        </ul>
    </div>
</div>

<div id="tab-withdraw" class="tab-box">
    <div class="card">
        <h3>Rút tiền về tài khoản</h3>
        <input type="number" id="w-amount" placeholder="Số tiền rút (Min 20,000)">
        <input type="text" id="w-info" placeholder="Ngân hàng - STK - Tên chủ thẻ">
        <button class="btn-do" style="width: 100%; margin-top: 10px; background: #0984e3;" onclick="handleWithdraw()">XÁC NHẬN RÚT TIỀN</button>
    </div>
    <div class="card">
        <h3>Lịch sử rút tiền</h3>
        <div id="render-withdraw-history">Chưa có lệnh rút nào.</div>
    </div>
</div>

<nav class="nav">
    <div class="nav-link active" onclick="goTab('tab-home', this)"><i class="fas fa-home"></i>Home</div>
    <div class="nav-link" onclick="goTab('tab-history', this)"><i class="fas fa-tasks"></i>Lịch sử</div>
    <div class="nav-link" onclick="goTab('tab-rules', this)"><i class="fas fa-info-circle"></i>Quy định</div>
    <div class="nav-link" onclick="goTab('tab-withdraw', this)"><i class="fas fa-wallet"></i>Rút tiền</div>
</nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fastraffic-8b585"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function goTab(tabId, element) {
        document.querySelectorAll('.tab-box').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        element.classList.add('active');
    }

    firebase.auth().onAuthStateChanged(user => {
        if (!user) { window.location.href = "index.html"; return; }
        const uid = user.uid;
        document.getElementById("u-mail").innerText = user.email;
        document.getElementById("u-uid").innerText = uid;

        // Cập nhật số dư
        db.ref("users/" + uid + "/money").on("value", s => {
            const val = s.val() || 0;
            document.getElementById("u-balance").innerText = val.toLocaleString() + "đ";
        });

        // Load Nhiệm vụ
        db.ref("Task").on("value", snap => {
            const div = document.getElementById("render-tasks");
            div.innerHTML = "";
            snap.forEach(group => {
                const groupName = group.key; 
                let bonus = (groupName === "Traffictot") ? 400 : (groupName === "Click1s" ? 600 : 500);

                group.forEach(taskItem => {
                    const data = taskItem.val();
                    const link = (typeof data === 'object') ? data.link : data; 
                    div.innerHTML += `
                        <div class="task-item">
                            <span><b>${groupName}</b> <br><small style="color:#888">+${bonus}đ mỗi lượt</small></span>
                            <button class="btn-do" onclick="doTask('${groupName}', '${link}', ${bonus})">Làm</button>
                        </div>`;
                });
            });
        });

        // Load Lịch sử
        db.ref("history/" + uid).on("value", s => {
            let h = ""; let w = "";
            s.forEach(c => {
                const d = c.val();
                const statusLbl = d.status === "pending" ? "Đang duyệt" : (d.status === "success" ? "Thành công" : "Bị từ chối");
                if (d.amount < 0) {
                    w = `<div class="task-item"><div><b>Rút ${Math.abs(d.amount).toLocaleString()}đ</b><br><small>${d.time}</small></div><div class="status-${d.status}">${statusLbl}</div></div>` + w;
                } else {
                    h = `<div class="task-item"><div><b>${d.task}</b><br><small>${d.time}</small></div><div class="status-${d.status}">${statusLbl}</div></div>` + h;
                }
            });
            document.getElementById("render-history").innerHTML = h || "Chưa có hoạt động.";
            document.getElementById("render-withdraw-history").innerHTML = w || "Chưa có lệnh rút.";
        });
    });

    function doTask(name, link, bonus) {
        window.open(link, "_blank");
        const uid = firebase.auth().currentUser.uid;
        db.ref("history/" + uid + "/" + Date.now()).set({
            task: name,
            amount: bonus,
            status: "pending",
            time: new Date().toLocaleString()
        });
    }

    function handleWithdraw() {
        const amt = parseInt(document.getElementById("w-amount").value);
        const info = document.getElementById("w-info").value;
        const uid = firebase.auth().currentUser.uid;
        if (amt < 20000 || !info) return alert("Tối thiểu 20k và nhập đầy đủ thông tin.");
        
        db.ref("users/" + uid + "/money").once("value", s => {
            const cur = s.val() || 0;
            if (cur < amt) return alert("Số dư không đủ.");
            db.ref("users/" + uid + "/money").set(cur - amt).then(() => {
                db.ref("history/" + uid + "/" + Date.now()).set({
                    task: "Rút tiền: " + info, amount: -amt, status: "pending", time: new Date().toLocaleString()
                });
                alert("Yêu cầu rút tiền đã được gửi!");
                document.getElementById("w-amount").value = "";
                document.getElementById("w-info").value = "";
            });
        });
    }
</script>
</body>
</html>
