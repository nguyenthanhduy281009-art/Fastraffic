<div id="withdraw" class="content-section">
    <h3><i class="fas fa-wallet"></i> Rút tiền</h3>
    
    <div style="background:white; padding:20px; border-radius:15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px;">
        <div class="form-group">
            <label>Ngân hàng / Ví</label>
            <select id="bank-name">
                <option value="MBBank">MBBank</option>
                <option value="Momo">Momo</option>
                <option value="Vietcombank">Vietcombank</option>
            </select>
        </div>
        <div class="form-group">
            <label>Số tài khoản / Số điện thoại</label>
            <input type="text" id="bank-acc" placeholder="Nhập STK nhận tiền">
        </div>
        <div class="form-group">
            <label>Số tiền rút (VNĐ)</label>
            <input type="number" id="withdraw-amount" placeholder="Tối thiểu 20.000">
        </div>
        <button class="btn-withdraw" onclick="requestWithdraw()">GỬI YÊU CẦU RÚT TIỀN</button>
    </div>

    <h3 style="font-size: 16px;"><i class="fas fa-clock"></i> Lịch sử rút tiền</h3>
    <div style="background:white; border-radius:10px; overflow:hidden;">
        <table>
            <thead>
                <tr>
                    <th>Thời gian</th>
                    <th>Số tiền</th>
                    <th>Ngân hàng</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody id="withdraw-history-list">
                <tr><td colspan="4" style="text-align:center; padding:20px;">Chưa có yêu cầu nào.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Trong phần Firebase Auth onAuthStateChanged, thêm đoạn code này:
    
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            const uid = user.email.replace(/\./g, '_');

            // Load riêng lịch sử rút tiền cho Tab Rút tiền
            db.ref(`history/${uid}`).on('value', s => {
                const list = document.getElementById('withdraw-history-list');
                list.innerHTML = '';
                if(s.exists()){
                    const data = Object.values(s.val()).reverse();
                    // Chỉ lọc ra các giao dịch là Rút tiền (có withdrawId hoặc amount âm)
                    const withdraws = data.filter(item => item.withdrawId || item.amount < 0);
                    
                    if(withdraws.length > 0) {
                        withdraws.forEach(item => {
                            let st = item.status === 'done' ? 'Thành công' : (item.status === 'pending' ? 'Chờ duyệt' : 'Đã hủy');
                            let cl = item.status === 'done' ? 'status-done' : (item.status === 'pending' ? 'status-pending' : 'status-cancelled');
                            
                            // Lấy tên ngân hàng từ dữ liệu nếu có, không thì để mặc định
                            let bank = item.bank || "N/A"; 

                            list.innerHTML += `<tr>
                                <td><small>${item.time || ''}</small></td>
                                <td style="color:red"><b>${item.amount.toLocaleString()}đ</b></td>
                                <td>${bank}</td>
                                <td class="${cl}">${st}</td>
                            </tr>`;
                        });
                    } else {
                        list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Chưa có yêu cầu nào.</td></tr>';
                    }
                }
            });
        }
    });

    // Cập nhật lại hàm requestWithdraw để lưu thêm tên ngân hàng vào history
    function requestWithdraw() {
        const user = firebase.auth().currentUser;
        const uid = user.email.replace(/\./g, '_');
        const bank = document.getElementById('bank-name').value;
        const acc = document.getElementById('bank-acc').value;
        const amt = parseInt(document.getElementById('withdraw-amount').value);

        db.ref(`users/${uid}/money`).once('value', s => {
            const current = s.val() || 0;
            if(!acc || !amt) return alert("Vui lòng nhập đầy đủ!");
            if(amt < 20000) return alert("Rút tối thiểu 20.000đ!");
            if(amt > current) return alert("Số dư không đủ!");

            const time = new Date().toLocaleString();
            const wId = "WD" + Date.now();

            db.ref(`withdraw_requests/${wId}`).set({
                userId: uid, bankName: bank, bankAcc: acc, amount: amt, status: 'pending', time: time
            });

            db.ref(`history/${uid}/${wId}`).set({
                amount: -amt, 
                status: 'pending', 
                time: time, 
                withdrawId: wId,
                bank: bank // Lưu thêm tên ngân hàng để hiển thị
            }).then(() => {
                alert("Đã gửi yêu cầu!");
                document.getElementById('bank-acc').value = "";
                document.getElementById('withdraw-amount').value = "";
            });
        });
    }
</script>
