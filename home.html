<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Chủ - Fastraffic</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding-bottom: 70px; }
        .card { background: white; margin: 15px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; }
        .balance { font-size: 24px; color: #2ecc71; font-weight: bold; margin: 10px 0; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .btn-task { background: #e94560; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; }
        .nav-item { text-align: center; font-size: 12px; color: #777; text-decoration: none; }
        .nav-item i { font-size: 20px; display: block; }
        .status-pending { color: orange; font-weight: bold; }
        .status-success { color: green; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <p>Xin chào: <b id="user-email">Đang tải...</b></p>
        <p>Số dư hiện tại</p>
        <div class="balance" id="user-balance">0đ</div>
    </div>

    <div class="card" style="text-align: left;">
        <h3><i class="fas fa-tasks"></i> Nhiệm vụ mới</h3>
        <div id="task-list-render">Đang tải nhiệm vụ...</div>
    </div>

    <div class="card" style="text-align: left;">
        <h3><i class="fas fa-history"></i> Lịch sử nhiệm vụ</h3>
        <div id="history-list">Đang tải lịch sử...</div>
    </div>

    <nav class="nav-bar">
        <a href="#" class="nav-item"><i class="fas fa-home"></i>Trang chủ</a>
        <a href="withdraw.html" class="nav-item"><i class="fas fa-wallet"></i>Rút tiền</a>
    </nav>

    <script>
        // 1. Cấu hình Firebase (BẠN HÃY ĐIỀN THÔNG TIN THẬT CỦA BẠN VÀO ĐÂY)
        const firebaseConfig = {
            apiKey: "AIza...",
            authDomain: "fastraffic-...",
            databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fastraffic-...",
            storageBucket: "fastraffic-...",
            messagingSenderId: "...",
            appId: "..."
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. Bảng giá cố định
        const priceMap = {
            "Traffictot": 250,
            "Click1s": 300
        };

        // 3. Tự động lấy nhiệm vụ từ Firebase
        db.ref('Task').on('value', snapshot => {
            const taskContainer = document.getElementById('task-list-render');
            if (!taskContainer) return;
            taskContainer.innerHTML = ''; 

            snapshot.forEach(child => {
                const taskName = child.key; 
                const taskLink = child.val(); 
                const taskPrice = priceMap[taskName] || 0; 

                taskContainer.innerHTML += `
                    <div class="task-item">
                        <div>
                            <b>${taskName}</b><br>
                            <small>Nhận ngay: <b style="color: #27ae60;">${taskPrice.toLocaleString()}đ</b></small>
                        </div>
                        <button class="btn-task" onclick="doTask('${taskName}', ${taskPrice}, '${taskLink}')">
                            Làm ngay
                        </button>
                    </div>`;
            });
        });

        // 4. Kiểm tra đăng nhập và tải dữ liệu người dùng
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                const uid = user.email.replace(/\./g, '_');
                document.getElementById('user-email').innerText = user.email;

                // Lấy số dư
                db.ref(`users/${uid}/money`).on('value', s => {
                    document.getElementById('user-balance').innerText = (s.val() || 0).toLocaleString() + "đ";
                });

                // Lấy lịch sử
                db.ref(`history/${uid}`).on('value', s => {
                    let html = '';
                    if(s.exists()){
                        s.forEach(child => {
                            const data = child.val();
                            if (data.amount > 0) { // Chỉ hiện tiền cộng (Nhiệm vụ)
                                html += `
                                <div class="task-item">
                                    <div>
                                        <b>${data.task}</b><br>
                                        <small>${data.time}</small>
                                    </div>
                                    <div class="${data.status === 'pending' ? 'status-pending' : 'status-success'}">
                                        +${data.amount}đ<br>
                                        <small>${data.status === 'pending' ? 'Chờ duyệt' : 'Hoàn thành'}</small>
                                    </div>
                                </div>`;
                            }
                        });
                    }
                    document.getElementById('history-list').innerHTML = html || "Chưa có lịch sử.";
                });
            } else {
                window.location.href = "login.html";
            }
        });

        // 5. Hàm xử lý làm nhiệm vụ
        function doTask(name, price, link) {
            if(!link || link === "undefined") return alert("Nhiệm vụ chưa có link!");
            window.open(link, '_blank'); 

            const user = firebase.auth().currentUser;
            const uid = user.email.replace(/\./g, '_');
            const taskId = "TASK_" + Date.now();

            db.ref(`history/${uid}/${taskId}`).set({
                task: name,
                amount: price,
                status: 'pending',
                time: new Date().toLocaleString()
            }).then(() => {
                alert("Đã mở link! Chờ Admin duyệt " + price + "đ.");
            });
        }
    </script>
</body>
</html>
