<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Chủ - FASTRAFFIC</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body{font-family:sans-serif;background:#f4f7f6;margin:0;padding-bottom:70px}
        .card{background:#fff;margin:10px;padding:15px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .balance-card{text-align:center;border-top:5px solid #27ae60}
        .balance-card h2{color:#27ae60;font-size:28px;margin:5px 0}
        .task-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee}
        .btn{background:#e74c3c;color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;font-weight:bold}
        .nav-bar{position:fixed;bottom:0;width:100%;background:#fff;display:flex;border-top:1px solid #ddd;z-index:1000}
        .nav-item{flex:1;text-align:center;padding:10px 0;font-size:12px;color:#666;cursor:pointer}
        .nav-item.active{color:#e74c3c;font-weight:bold}
        .nav-item i{display:block;font-size:18px;margin-bottom:2px}
        .tab-content{display:none}
        .tab-content.active{display:block}
        input{width:100%;padding:10px;margin:5px 0;border:1px solid #ccc;border-radius:5px;box-sizing:border-box}
        .pending{color:#f39c12;font-weight:bold}
        .success{color:#27ae60;font-weight:bold}
        .hist-label{font-size:14px;font-weight:bold;color:#333;margin:15px 5px;border-left:4px solid #e74c3c;padding-left:8px}
    </style>
</head>
<body>

<div id="home" class="tab-content active">
    <div class="card" style="text-align:center"><b>Xin chào: <span id="u-email">...</span></b></div>
    <div class="card balance-card">
        <p style="margin:0">Số dư hiện tại</p>
        <h2 id="u-balance">0đ</h2>
    </div>
    <div class="card">
        <h3><i class="fas fa-list"></i> Nhiệm vụ hiện có</h3>
        <div id="render-tasks">Đang tải nhiệm vụ...</div>
    </div>
</div>

<div id="history" class="tab-content">
    <div class="card">
        <div class="hist-label">NHIỆM VỤ ĐÃ LÀM</div>
        <div id="task-history">Trống.</div>
        <div class="hist-label">LỊCH SỬ RÚT TIỀN</div>
        <div id="withdraw-history">Trống.</div>
    </div>
</div>

<div id="withdraw" class="tab-content">
    <div class="card">
        <h3><i class="fas fa-wallet"></i> Yêu cầu rút tiền</h3>
        <input type="number" id="w-amount" placeholder="Số tiền (Tối thiểu 20.000đ)">
        <input type="text" id="w-info" placeholder="STK - Ngân hàng - Tên chủ thẻ">
        <button class="btn" style="width:100%;margin-top:10px" onclick="sendWithdraw()">GỬI YÊU CẦU</button>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="tab('home',this)"><i class="fas fa-home"></i>Trang chủ</div>
    <div class="nav-item" onclick="tab('history',this)"><i class="fas fa-history"></i>Lịch sử</div>
    <div class="nav-item" onclick="tab('withdraw',this)"><i class="fas fa-money-bill-wave"></i>Rút tiền</div>
</nav>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fastraffic-8b585"
    });
    const db = firebase.database();
    const prices = { Traffictot: 400, Click1s: 600 }; // Giá tiền cho từng loại nhiệm vụ

    function tab(id, el){
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    firebase.auth().onAuthStateChanged(user=>{
        if(!user){ window.location.href = "index.html"; return; }
        const uid = user.uid;
        document.getElementById("u-email").innerText = user.email;

        // Lấy số dư thực tế từ Firebase
        db.ref("users/"+uid+"/money").on("value",s=>{
            document.getElementById("u-balance").innerText = (s.val()||0).toLocaleString()+"đ";
        });

        // Tự động load danh sách nhiệm vụ
        db.ref("Task").on("value",snap=>{
            const div = document.getElementById("render-tasks");
            div.innerHTML="";
            snap.forEach(task=>{
                const name = task.key;
                task.forEach(l=>{
                    let link = l.val();
                    if(typeof link === 'object') link = link.link;
                    div.innerHTML += `<div class="task-item">
                        <div><b>${name}</b><br><small>+${prices[name]||0}đ</small></div>
                        <button class="btn" onclick="doTask('${name}',${prices[name]||0},'${link}')">Làm</button>
                    </div>`;
                });
            });
        });

        // Hiển thị lịch sử tách biệt
        db.ref("history/"+uid).on("value",s=>{
            let taskH = ""; let drawH = "";
            s.forEach(c=>{
                const d = c.val();
                const row = `<div class="task-item">
                    <div><b>${d.task}</b><br><small>${d.time}</small></div>
                    <div class="${d.status==='pending'?'pending':'success'}">${d.amount>0?'+':''}${d.amount.toLocaleString()}đ</div>
                </div>`;
                if(d.amount > 0) taskH = row + taskH; else drawH = row + drawH;
            });
            document.getElementById("task-history").innerHTML = taskH || "Chưa có nhiệm vụ.";
            document.getElementById("withdraw-history").innerHTML = drawH || "Chưa có yêu cầu.";
        });
    });

    function doTask(name, price, link){
        window.open(link,"_blank");
        const uid = firebase.auth().currentUser.uid;
        // Lưu nhiệm vụ chờ duyệt
        db.ref("history/"+uid+"/"+Date.now()).set({
            task:name, amount:price, status:"pending", time:new Date().toLocaleString()
        });
    }

    function sendWithdraw(){
        const amount = parseInt(document.getElementById("w-amount").value);
        const info = document.getElementById("w-info").value;
        if(amount < 20000 || !info) return alert("Tối thiểu 20k và nhập đầy đủ thông tin!");
        const uid = firebase.auth().currentUser.uid;
        db.ref("users/"+uid+"/money").once("value",s=>{
            const money = s.val()||0;
            if(money < amount) return alert("Số dư không đủ!");
            // Trừ tiền ngay khi yêu cầu rút
            db.ref("users/"+uid+"/money").set(money - amount);
            db.ref("history/"+uid+"/"+Date.now()).set({
                task:"Rút tiền: " + info, amount:-amount, status:"pending", time:new Date().toLocaleString()
            });
            alert("Đã gửi yêu cầu rút tiền thành công!");
        });
    }
</script>
</body>
</html>
