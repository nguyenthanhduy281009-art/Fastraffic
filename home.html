<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTRAFFIC PREMIUM</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --p: #6c5ce7; --bg: #f8faff; --t: #2d3436; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: var(--t); }
        .user-header { background: #fff; padding: 20px; border-radius: 0 0 25px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-header b { font-size: 15px; color: var(--p); }
        .balance-card { background: linear-gradient(135deg, #6c5ce7, #a29bfe); margin: 15px; padding: 25px; border-radius: 20px; color: #fff; box-shadow: 0 10px 25px rgba(108, 92, 231, 0.3); }
        .balance-val { font-size: 30px; font-weight: 800; display: block; margin: 5px 0; }
        .group-box { margin: 15px; background: #fff; border-radius: 15px; overflow: hidden; border: 1px solid #eee; }
        .group-head { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; }
        .group-head i.arrow { transition: 0.3s; transform: rotate(0deg); color: #ccc; } 
        .group-head.active i.arrow { transform: rotate(180deg); color: var(--p); }
        .group-content { display: none; padding: 0 15px; background: #fafafa; }
        .group-content.show { display: block; }
        .task-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed #eee; }
        .task-row:last-child { border-bottom: none; }
        .btn-go { background: var(--p); color: #fff; border: none; padding: 8px 18px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .navbar { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; height: 70px; box-shadow: 0 -2px 15px rgba(0,0,0,0.05); z-index: 99; }
        .nav-item { flex: 1; text-align: center; padding-top: 15px; color: #b2bec3; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--p); font-weight: bold; }
        .nav-item i { display: block; font-size: 22px; margin-bottom: 2px; }
        .tab { display: none; }
        .tab.active { display: block; }
        .card { background: #fff; margin: 15px; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .stt-box { text-align: right; min-width: 90px; }
        .stt-text { font-size: 11px; font-weight: bold; display: block; margin-top: 3px; }
    </style>
</head>
<body>

<div id="tab-home" class="tab active">
    <div class="user-header">Chào: <b id="u-mail">...</b><small style="display: block; color: #b2bec3; font-size: 11px; margin-top: 5px;">ID: <span id="u-uid">...</span></small></div>
    <div class="balance-card"><small style="opacity:0.8">SỐ DƯ KHẢ DỤNG</small><span class="balance-val" id="u-balance">0đ</span></div>
    <h4 style="margin: 20px 15px 10px"><i class="fas fa-star" style="color:#f1c40f"></i> Nhiệm vụ của bạn</h4>
    <div id="render-tasks">Đang tải...</div>
</div>

<div id="tab-history" class="tab">
    <div class="user-header"><b>Lịch sử nhiệm vụ</b></div>
    <div id="render-history-tasks" style="padding:15px"></div>
</div>

<div id="tab-rules" class="tab">
    <div class="user-header"><b>Quy định hệ thống</b></div>
    <div class="card">
        <ul style="padding-left: 20px; line-height: 2; color: #636e72;">
            <li>Không dùng VPN, Fake IP, Proxy.</li>
            <li>Rút tiền tối thiểu từ 20.000đ.</li>
            <li>Nhiệm vụ sẽ được duyệt sau 24h.</li>
        </ul>
    </div>
</div>

<div id="tab-withdraw" class="tab">
    <div class="user-header"><b>Rút tiền về ví</b></div>
    <div class="card">
        <input type="number" id="w-amount" placeholder="Số tiền rút (Min 20k)">
        <input type="text" id="w-info" placeholder="Ngân hàng - STK - Tên">
        <button class="btn-go" style="width:100%; height:45px; margin-top:10px" onclick="handleWithdraw()">XÁC NHẬN RÚT</button>
    </div>
    <h4 style="margin: 20px 15px 10px">Lịch sử rút tiền</h4>
    <div id="render-history-withdraw" style="padding:15px"></div>
</div>

<nav class="navbar">
    <div class="nav-item active" onclick="goTab('tab-home', this)"><i class="fas fa-home"></i>Home</div>
    <div class="nav-item" onclick="goTab('tab-history', this)"><i class="fas fa-history"></i>Lịch sử</div>
    <div class="nav-item" onclick="goTab('tab-rules', this)"><i class="fas fa-book"></i>Quy định</div>
    <div class="nav-item" onclick="goTab('tab-withdraw', this)"><i class="fas fa-wallet"></i>Rút tiền</div>
</nav>

<script>
    const config = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fastraffic-8b585"
    };
    if (!firebase.apps.length) firebase.initializeApp(config);
    const db = firebase.database();

    function goTab(id, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    function toggleGroup(id, el) {
        document.getElementById(id).classList.toggle('show');
        el.classList.toggle('active');
    }

    function doTask(name, link, bonus) {
        window.open(link, "_blank");
        const uid = firebase.auth().currentUser.uid;
        db.ref("history/" + uid + "/" + Date.now()).set({
            task: name, amount: bonus, status: "pending", time: new Date().toLocaleString()
        });
        alert("Nhiệm vụ đã gửi, vui lòng chờ duyệt!");
    }

    function handleWithdraw() {
        const amt = parseInt(document.getElementById("w-amount").value);
        const info = document.getElementById("w-info").value;
        const uid = firebase.auth().currentUser.uid;
        if (amt < 20000 || !info) return alert("Kiểm tra lại số tiền và thông tin!");

        db.ref("users/" + uid + "/money").once("value", s => {
            const cur = s.val() || 0;
            if (cur < amt) return alert("Không đủ số dư!");
            db.ref("users/" + uid + "/money").set(cur - amt).then(() => {
                db.ref("history/" + uid + "/" + Date.now()).set({
                    task: "Rút tiền", 
                    amount: amt, 
                    info: info, 
                    type: "withdraw",
                    status: "processing", 
                    time: new Date().toLocaleString()
                });
                alert("Yêu cầu đã được gửi thành công, xin vui lòng chờ từ 1 đến 3 ngày!");
            });
        });
    }

    firebase.auth().onAuthStateChanged(user => {
        if (!user) return;
        document.getElementById("u-mail").innerText = user.email;
        document.getElementById("u-uid").innerText = user.uid;

        db.ref("users/" + user.uid + "/money").on("value", s => {
            document.getElementById("u-balance").innerText = (s.val() || 0).toLocaleString() + "đ";
        });

        db.ref("Task").on("value", snap => {
            const div = document.getElementById("render-tasks"); div.innerHTML = "";
            snap.forEach(g => {
                const name = g.key;
                let bonus = (name === "Traffictot") ? 400 : (name === "Click1s" ? 600 : 500);
                const cId = 'c-' + name.replace(/\s+/g, '');
                let h = `<div class="group-box"><div class="group-head" onclick="toggleGroup('${cId}', this)"><span>${name} (+${bonus}đ)</span><i class="fas fa-chevron-down arrow"></i></div><div id="${cId}" class="group-content">`;
                g.forEach(t => {
                    const l = (typeof t.val() === 'object') ? t.val().link : t.val();
                    h += `<div class="task-row"><span>Nhiệm vụ #${t.key}</span><button class="btn-go" onclick="doTask('${name}', '${l}', ${bonus})">Làm</button></div>`;
                });
                h += `</div></div>`; div.innerHTML += h;
            });
        });

        db.ref("history/" + user.uid).on("value", s => {
            let taskH = ""; let drawH = "";
            s.forEach(c => {
                const d = c.val();
                const isW = d.type === "withdraw" || d.amount < 0 || d.task === "Rút tiền";
                const stText = d.status === "pending" || d.status === "processing" ? "Chờ duyệt" : (d.status === "success" ? "Thành công" : "Từ chối");
                const stCol = (d.status === "pending" || d.status === "processing") ? "#f39c12" : (d.status === "success" ? "#27ae60" : "#e74c3c");

                const ui = `<div class="task-row" style="padding: 12px 0;">
                    <div>
                        <b style="font-size:14px">${d.task}${isW ? ': ' + Math.abs(d.amount).toLocaleString() + 'đ' : ''}</b><br>
                        <small style="color:#b2bec3">${d.time}</small>
                    </div>
                    <div class="stt-box">
                        <span class="stt-text" style="color:${stCol}">${stText}</span>
                        ${!isW ? '<b style="color:#27ae60">+' + d.amount.toLocaleString() + 'đ</b>' : ''}
                    </div>
                </div>`;
                if (isW) drawH = ui + drawH; else taskH = ui + taskH;
            });
            document.getElementById("render-history-tasks").innerHTML = taskH || "Chưa có dữ liệu.";
            document.getElementById("render-history-withdraw").innerHTML = drawH || "Chưa có lệnh rút.";
        });
    });
</script>
</body>
</html>
