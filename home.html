<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTRAFFIC - Trang ch·ªß</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        .header { background: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .balance-card { background: white; margin: 15px; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .balance-amount { font-size: 28px; color: #2ecc71; font-weight: bold; margin: 10px 0; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1000; }
        .nav-item { text-align: center; color: #666; text-decoration: none; font-size: 12px; flex: 1; border: none; background: none; cursor: pointer; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: #e94560; }

        .content-section { padding: 15px; display: none; }
        .content-section.active { display: block; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-withdraw { width: 100%; padding: 12px; background: #e94560; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        .status-done { color: #27ae60; font-weight: bold; }
        .status-pending { color: #f39c12; font-weight: bold; }
        .status-cancelled { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header"><h2 style="margin:0; color:#e94560;">FASTRAFFIC</h2></div>
    <div class="user-welcome" style="background: white; margin: 15px; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
    <div style="background: #ffeef0; color: #e94560; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
        <i class="fas fa-user"></i>
    </div>
    <div>
        <div style="font-size: 12px; color: #666;">Xin ch√†o t√†i kho·∫£n:</div>
        <div id="user-display-email" style="font-weight: bold; color: #333; font-size: 14px;">ƒêang t·∫£i...</div>
    </div>
</div>

    <div id="home" class="content-section active">
        <div class="balance-card">
            <p style="margin:0; color:#666;">S·ªë d∆∞ hi·ªán t·∫°i</p>
            <div class="balance-amount" id="user-money">0ƒë</div>
        </div>
        <div style="padding:15px; background:white; border-radius:10px;">
            <p>üëã Ch√†o m·ª´ng b·∫°n! H√£y ho√†n th√†nh nhi·ªám v·ª• ƒë·ªÉ nh·∫≠n th√™m ti·ªÅn.</p>
        </div>
    </div>

    <div id="history" class="content-section">
        <h3><i class="fas fa-history"></i> L·ªãch s·ª≠ nhi·ªám v·ª•</h3>
        <table>
            <thead><tr><th>Th·ªùi gian</th><th>S·ªë ti·ªÅn</th><th>Tr·∫°ng th√°i</th></tr></thead>
            <tbody id="history-list"></tbody>
        </table>
    </div>

    <div id="rules" class="content-section">
        <h3><i class="fas fa-book"></i> Quy ƒë·ªãnh</h3>
        <div style="background:white; padding:15px; border-radius:10px;">
            <p>‚Ä¢ R√∫t ti·ªÅn t·ªëi thi·ªÉu: 20.000ƒë.</p>
            <p>‚Ä¢ Th·ªùi gian duy·ªát: 5-30 ph√∫t.</p>
        </div>
    </div>

    <div id="withdraw" class="content-section">
        <h3><i class="fas fa-wallet"></i> R√∫t ti·ªÅn</h3>
        <div style="background:white; padding:15px; border-radius:15px; margin-bottom: 20px;">
            <div class="form-group"><label>Ng√¢n h√†ng</label><select id="bank-name"><option value="MBBank">MBBank</option><option value="Momo">Momo</option></select></div>
            <div class="form-group"><label>S·ªë t√†i kho·∫£n</label><input type="text" id="bank-acc" placeholder="S·ªë t√†i kho·∫£n"></div>
            <div class="form-group"><label>S·ªë ti·ªÅn r√∫t</label><input type="number" id="withdraw-amount" placeholder="T·ª´ 20.000"></div>
            <button class="btn-withdraw" onclick="requestWithdraw()">G·ª¨I Y√äU C·∫¶U</button>
        </div>

        <h4><i class="fas fa-clock"></i> L·ªãch s·ª≠ r√∫t ti·ªÅn</h4>
        <table>
            <thead><tr><th>Th·ªùi gian</th><th>S·ªë ti·ªÅn</th><th>Tr·∫°ng th√°i</th></tr></thead>
            <tbody id="withdraw-history-list"></tbody>
        </table>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="showTab('home', this)"><i class="fas fa-home"></i>Trang ch·ªß</button>
        <button class="nav-item" onclick="showTab('history', this)"><i class="fas fa-history"></i>L·ªãch s·ª≠</button>
        <button class="nav-item" onclick="showTab('rules', this)"><i class="fas fa-book"></i>Quy ƒë·ªãnh</button>
        <button class="nav-item" onclick="showTab('withdraw', this)"><i class="fas fa-wallet"></i>R√∫t ti·ªÅn</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        projectId: "fastraffic-8b585",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function showTab(tabId, el) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        el.classList.add('active');
    }

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            const uid = user.email.replace(/\./g, '_');
            db.ref(`users/${uid}/money`).on('value', s => {
                document.getElementById('user-money').innerText = (s.val() || 0).toLocaleString() + "ƒë";
            });

            // L·∫•y d·ªØ li·ªáu l·ªãch s·ª≠
            db.ref(`history/${uid}`).on('value', s => {
                const historyList = document.getElementById('history-list');
                const withdrawList = document.getElementById('withdraw-history-list');
                historyList.innerHTML = ''; withdrawList.innerHTML = '';
                
                if(s.exists()){
                    // S·∫Øp x·∫øp d·ªØ li·ªáu m·ªõi nh·∫•t l√™n ƒë·∫ßu
                    const items = [];
                    s.forEach(child => { items.push(child.val()); });
                    items.reverse().forEach(item => {
                        let stText = item.status === 'done' ? 'Th√†nh c√¥ng' : (item.status === 'pending' ? 'Ch·ªù duy·ªát' : 'ƒê√£ h·ªßy');
                        let html = `<tr><td><small>${item.time||''}</small></td><td>${item.amount.toLocaleString()}ƒë</td><td class="status-${item.status}">${stText}</td></tr>`;
                        
                        // N·∫øu amount √¢m ( < 0 ) l√† r√∫t ti·ªÅn, ƒë·∫©y v√†o b·∫£ng r√∫t ti·ªÅn
                        if(item.amount < 0) {
                            withdrawList.innerHTML += html;
                        } else {
                            historyList.innerHTML += html;
                        }
                    });
                }
                if(!withdrawList.innerHTML) withdrawList.innerHTML = '<tr><td colspan="3" style="text-align:center">Ch∆∞a c√≥ l·ªánh r√∫t n√†o.</td></tr>';
                if(!historyList.innerHTML) historyList.innerHTML = '<tr><td colspan="3" style="text-align:center">Ch∆∞a c√≥ nhi·ªám v·ª• n√†o.</td></tr>';
            });
        } else { location.href = 'login.html'; }
    });

    function requestWithdraw() {
        const user = firebase.auth().currentUser;
        const uid = user.email.replace(/\./g, '_');
        const bank = document.getElementById('bank-name').value;
        const acc = document.getElementById('bank-acc').value;
        const amt = parseInt(document.getElementById('withdraw-amount').value);

        db.ref(`users/${uid}/money`).once('value', s => {
            const current = s.val() || 0;
            if(!acc || !amt || amt < 20000) return alert("Ki·ªÉm tra l·∫°i th√¥ng tin!");
            if(amt > current) return alert("S·ªë d∆∞ kh√¥ng ƒë·ªß!");

            const wId = "WD" + Date.now();
            const time = new Date().toLocaleString();

            db.ref(`withdraw_requests/${wId}`).set({ userId: uid, bankName: bank, bankAcc: acc, amount: amt, status: 'pending', time: time });
            db.ref(`history/${uid}/${wId}`).set({ amount: -amt, status: 'pending', time: time, withdrawId: wId })
            .then(() => { alert("ƒê√£ g·ª≠i y√™u c·∫ßu!"); });
        });
    }
</script>
</body>
</html>

