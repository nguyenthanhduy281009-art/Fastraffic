<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTRAFFIC - Hệ thống</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding-bottom: 80px; }
        .card { background: #fff; margin: 10px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .balance-val { text-align: center; color: #27ae60; font-size: 32px; font-weight: bold; margin: 10px 0; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .btn-do { background: #e74c3c; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #eee; height: 65px; z-index: 9999; }
        .nav-link { flex: 1; text-align: center; padding-top: 12px; font-size: 11px; color: #888; cursor: pointer; }
        .nav-link.active { color: #e74c3c; font-weight: bold; }
        .nav-link i { display: block; font-size: 20px; margin-bottom: 3px; }
        .tab-box { display: none; padding: 5px; }
        .tab-box.active { display: block; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1.5px solid #eee; border-radius: 8px; box-sizing: border-box; }
        .hist-status { font-weight: bold; font-size: 13px; }
        .status-pending { color: #f39c12; }
        .status-success { color: #27ae60; }
        .status-rejected { color: #e74c3c; }
    </style>
</head>
<body>

<div id="tab-home" class="tab-box active">
    <div class="card" style="font-size: 14px;">Xin chào: <b id="u-mail">...</b></div>
    <div class="card">
        <p style="text-align:center; margin:0; color: #666;">Số dư của bạn</p>
        <div class="balance-val" id="u-balance">0đ</div>
    </div>
    <div class="card">
        <h3><i class="fas fa-fire"></i> Nhiệm vụ:</h3>
        <div id="render-tasks">Đang tải dữ liệu...</div>
    </div>
</div>

<div id="tab-history" class="tab-box">
    <div class="card">
        <h3><i class="fas fa-history"></i> Lịch sử nhiệm vụ</h3>
        <div id="render-history">Chưa có hoạt động nào.</div>
    </div>
</div>

<div id="tab-rules" class="tab-box">
    <div class="card">
        <h3><i class="fas fa-shield-alt"></i> Quy định chung</h3>
        <ul style="padding-left: 20px; line-height: 1.8; color: #444;">
            <li>Không dùng công cụ auto, giả lập.</li>
            <li>Rút tiền tối thiểu từ 20.000đ.</li>
            <li>Duyệt rút tiền trong 24h - 48h.</li>
        </ul>
    </div>
</div>

<div id="tab-withdraw" class="tab-box">
    <div class="card">
        <h3><i class="fas fa-money-check-alt"></i> Đặt lệnh rút tiền</h3>
        <input type="number" id="w-amount" placeholder="Số tiền muốn rút (Min 20k)">
        <input type="text" id="w-info" placeholder="STK - Ngân hàng - Tên chủ tài khoản">
        <button class="btn-do" style="width: 100%; margin-top: 10px;" onclick="handleWithdraw()">XÁC NHẬN RÚT</button>
    </div>
    <div class="card">
        <h3><i class="fas fa-list"></i> Lịch sử rút tiền</h3>
        <div id="render-withdraw-history">Chưa có lệnh rút nào.</div>
    </div>
</div>

<nav class="nav">
    <div class="nav-link active" onclick="goTab('tab-home', this)"><i class="fas fa-home"></i>Home</div>
    <div class="nav-link" onclick="goTab('tab-history', this)"><i class="fas fa-list-ul"></i>Lịch sử</div>
    <div class="nav-link" onclick="goTab('tab-rules', this)"><i class="fas fa-book"></i>Quy định</div>
    <div class="nav-link" onclick="goTab('tab-withdraw', this)"><i class="fas fa-wallet"></i>Rút tiền</div>
</nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fastraffic-8b585"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function goTab(tabId, element) {
        document.querySelectorAll('.tab-box').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        element.classList.add('active');
    }

    firebase.auth().onAuthStateChanged(user => {
        if (!user) { window.location.href = "index.html"; return; }
        const uid = user.uid;
        document.getElementById("u-mail").innerText = user.email;

        db.ref("users/" + uid + "/money").on("value", s => {
            document.getElementById("u-balance").innerText = (s.val() || 0).toLocaleString() + "đ";
        });

        // Tải nhiệm vụ từ Firebase
        db.ref("Task").on("value", snap => {
            const div = document.getElementById("render-tasks");
            div.innerHTML = "";
            snap.forEach(group => {
                const groupName = group.key; 
                let bonus = 500; 
                if (groupName === "Traffictot") bonus = 400;
                if (groupName === "Click1s") bonus = 600;

                group.forEach(taskItem => {
                    const data = taskItem.val();
                    const link = (typeof data === 'object') ? data.link : data; 
                    div.innerHTML += `
                        <div class="task-item">
                            <span><b>${groupName}</b> (${bonus}đ)</span>
                            <button class="btn-do" onclick="doTask('${groupName}', '${link}', ${bonus})">Làm</button>
                        </div>`;
                });
            });
        });

        // Hiển thị lịch sử
        db.ref("history/" + uid).on("value", s => {
            let h = ""; let w = "";
            s.forEach(c => {
                const d = c.val();
                const statusText = d.status === "pending" ? "Đang duyệt" : (d.status === "success" ? "Thành công" : "Thất bại");
                if (d.amount < 0) {
                    w = `<div class="task-item"><div><b>Rút ${Math.abs(d.amount)}đ</b><br><small>${d.time}</small></div><div class="status-${d.status}">${statusText}</div></div>` + w;
                } else {
                    h = `<div class="task-item"><div><b>${d.task}</b><br><small>${d.time}</small></div><div class="status-${d.status}">${statusText}</div></div>` + h;
                }
            });
            document.getElementById("render-history").innerHTML = h || "Trống.";
            document.getElementById("render-withdraw-history").innerHTML = w || "Trống.";
        });
    });

    // Hàm thực hiện nhiệm vụ - ĐÃ ĐỊNH NGHĨA LẠI Ở ĐÂY
    function doTask(name, link, bonus) {
        window.open(link, "_blank");
        const uid = firebase.auth().currentUser.uid;
        db.ref("history/" + uid + "/" + Date.now()).set({
            task: name,
            amount: bonus,
            status: "pending",
            time: new Date().toLocaleString()
        });
    }

    function handleWithdraw() {
        const amt = parseInt(document.getElementById("w-amount").value);
        const info = document.getElementById("w-info").value;
        const uid = firebase.auth().currentUser.uid;
        if (amt < 20000 || !info) return alert("Min 20k và nhập đủ thông tin!");
        db.ref("users/" + uid + "/money").once("value", s => {
            const cur = s.val() || 0;
            if (cur < amt) return alert("Số dư không đủ!");
            db.ref("users/" + uid + "/money").set(cur - amt).then(() => {
                db.ref("history/" + uid + "/" + Date.now()).set({
                    task: "Rút về: " + info, amount: -amt, status: "pending", time: new Date().toLocaleString()
                });
                alert("Đã gửi yêu cầu rút tiền!");
            });
        });
    }
</script>
</body>
</html>




