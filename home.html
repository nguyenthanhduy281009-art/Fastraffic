<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTRAFFIC - Hệ thống nhiệm vụ</title>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body{font-family:sans-serif;background:#f4f7f6;margin:0;padding-bottom:70px}
        .card{background:#fff;margin:10px;padding:15px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .balance-card{text-align:center;border-top:5px solid #27ae60}
        .balance-card h2{color:#27ae60;font-size:28px}
        .task-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee}
        .btn{background:#e74c3c;color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;font-weight:bold}
        .nav-bar{position:fixed;bottom:0;width:100%;background:#fff;display:flex;border-top:1px solid #ddd}
        .nav-item{flex:1;text-align:center;padding:10px 0;font-size:12px;color:#666;cursor:pointer}
        .nav-item.active{color:#e74c3c;font-weight:bold}
        .nav-item i{display:block;font-size:18px}
        .tab-content{display:none}
        .tab-content.active{display:block}
        input{width:100%;padding:10px;margin:5px 0;border:1px solid #ccc;border-radius:5px}
        .pending{color:#f39c12;font-weight:bold}
        .success{color:#27ae60;font-weight:bold}
    </style>
</head>
<body>

<div id="home" class="tab-content active">
    <div class="card" style="text-align:center"><b>Chào: <span id="u-email">...</span></b></div>
    <div class="card balance-card">
        <p>Số dư tài khoản</p>
        <h2 id="u-balance">0đ</h2>
    </div>
    <div class="card">
        <h3><i class="fas fa-list"></i> Nhiệm vụ</h3>
        <div id="render-tasks">Đang tải...</div>
    </div>
</div>

<div id="withdraw" class="tab-content">
    <div class="card">
        <h3><i class="fas fa-wallet"></i> Rút tiền</h3>
        <input type="number" id="w-amount" placeholder="Số tiền cần rút">
        <input type="text" id="w-info" placeholder="STK - Ngân hàng - Tên">
        <button class="btn" style="width:100%" onclick="sendWithdraw()">GỬI</button>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="tab('home',this)"><i class="fas fa-home"></i>Home</div>
    <div class="nav-item" onclick="tab('withdraw',this)"><i class="fas fa-money-bill"></i>Rút</div>
</nav>

<script>
/* ========= FIREBASE CONFIG ========= */
firebase.initializeApp({
    apiKey: "AIza...",
    authDomain: "fastraffic-8b585.firebaseapp.com",
    databaseURL: "https://fastraffic-8b585-default-rtdb.firebaseio.com",
    projectId: "fastraffic-8b585"
});

const db = firebase.database();
const prices = { Traffictot: 400, Click1s: 600 };

/* ========= TAB ========= */
function tab(id, el){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active');
}

/* ========= AUTH ========= */
firebase.auth().onAuthStateChanged(user=>{
    if(!user){
        window.location.href = "/login.html"; // ĐÚNG FILE LOGIN
        return;
    }

    const uid = user.uid;
    document.getElementById("u-email").innerText = user.email;

    db.ref("users/"+uid+"/money").on("value",s=>{
        document.getElementById("u-balance").innerText = (s.val()||0).toLocaleString()+"đ";
    });

    db.ref("Task").on("value",snap=>{
        const div = document.getElementById("render-tasks");
        div.innerHTML="";
        snap.forEach(task=>{
            const name = task.key;
            task.forEach(l=>{
                const link = l.val();
                if(!link || !link.startsWith("http")) return;
                div.innerHTML += `
                <div class="task-item">
                    <div><b>${name}</b><br>+${prices[name]||0}đ</div>
                    <button class="btn" onclick="doTask('${name}',${prices[name]||0},'${link}')">Làm</button>
                </div>`;
            });
        });
    });
});

/* ========= TASK ========= */
function doTask(name, price, link){
    window.open(link,"_blank");
    const uid = firebase.auth().currentUser.uid;
    db.ref("history/"+uid+"/"+Date.now()).set({
        task:name, amount:price, status:"pending", time:new Date().toLocaleString()
    });
}

/* ========= WITHDRAW ========= */
function sendWithdraw(){
    const amount = parseInt(w-amount.value);
    const info = w-info.value;
    if(amount<20000 || !info) return alert("Min 20k + nhập thông tin");

    const uid = firebase.auth().currentUser.uid;
    db.ref("users/"+uid+"/money").once("value",s=>{
        const money = s.val()||0;
        if(money<amount) return alert("Không đủ tiền");
        db.ref("users/"+uid+"/money").set(money-amount);
        db.ref("history/"+uid+"/"+Date.now()).set({
            task:"Rút tiền", amount:-amount, status:"pending", time:new Date().toLocaleString()
        });
        alert("Đã gửi yêu cầu");
    });
}
</script>
</body>
</html>



