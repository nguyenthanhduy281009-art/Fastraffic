<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fastraffic - Trang chủ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; display: flex; background: #f4f7f6; overflow-x: hidden; }
        .sidebar { width: 250px; background: #fff; height: 100vh; border-right: 1px solid #ddd; position: fixed; z-index: 100; }
        .sidebar-header { padding: 25px; font-weight: bold; color: #e94560; font-size: 22px; text-align: center; border-bottom: 1px solid #eee; }
        .menu-item { padding: 15px 20px; display: flex; align-items: center; color: #333; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: #fff5f6; color: #e94560; border-left: 4px solid #e94560; }
        .menu-item i { width: 30px; font-size: 18px; }
        
        .main { margin-left: 250px; flex: 1; min-height: 100vh; width: calc(100% - 250px); }
        .top-bar { background: #fff; padding: 15px 25px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 90; }
        .content { padding: 40px; }
        
        .logout { background: #ff4d4d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .money-card { background: linear-gradient(135deg, #e94560, #ff6b81); color: white; padding: 30px; border-radius: 20px; display: inline-block; min-width: 320px; box-shadow: 0 10px 20px rgba(233, 69, 96, 0.2); }
        .money-card h3 { margin: 0; font-size: 15px; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.9; }
        #userMoney { font-size: 38px; font-weight: bold; margin-top: 15px; }

        #userMail { color: #e94560; font-weight: bold; }
        h2 { font-size: 28px; color: #1a1a1a; margin-top: 0; margin-bottom: 25px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">FASTRAFFIC</div>
    <div class="menu-item active" onclick="show('trangchu')"><i class="fas fa-home"></i> Trang chủ</div>
    <div class="menu-item" onclick="show('lichsu')"><i class="fas fa-history"></i> Lịch sử</div>
    <div class="menu-item" onclick="show('quydinh')"><i class="fas fa-gavel"></i> Quy định</div>
    <div class="menu-item" onclick="show('ruttien')"><i class="fas fa-wallet"></i> Rút tiền</div>
</div>

<div class="main">
    <div class="top-bar">
        <span>Chào mừng, <span id="userMail">Đang xác thực...</span></span>
        <button class="logout" onclick="logout()">Đăng xuất</button>
    </div>
    <div class="content" id="view">
        </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        projectId: "fastraffic-8b585",
        databaseURL: "https://fastraffic-8b585-default-rtdb.firebaseio.com"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }

    let currentEmail = "";

    // Lắng nghe trạng thái đăng nhập
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            currentEmail = user.email;
            document.getElementById("userMail").innerText = currentEmail;
            show('trangchu'); // Vẽ giao diện ngay khi có user
            user.getIdToken(true).catch(() => logout());
        } else {
            window.location.href = "index.html";
        }
    });

    function loadMoneyData(email) {
        const userId = email.replace(/\./g, '_');
        const dbPath = firebase.database().ref('users/' + userId + '/money');
        
        // Dùng .on để cập nhật tiền theo thời gian thực
        dbPath.on('value', (snapshot) => {
            const money = snapshot.val();
            const moneyDisplay = document.getElementById("userMoney");
            
            if (moneyDisplay) {
                if (money === null) {
                    // Nếu chưa có ví tiền, tự tạo 0 VNĐ
                    firebase.database().ref('users/' + userId).update({ money: 0 });
                    moneyDisplay.innerText = "0 VNĐ";
                } else {
                    moneyDisplay.innerText = money.toLocaleString('vi-VN') + " VNĐ";
                }
            }
        }, (error) => {
            console.error("Lỗi Rules: ", error);
            if(document.getElementById("userMoney")) {
                document.getElementById("userMoney").innerText = "Lỗi kết nối!";
            }
        });
    }

    function show(p) {
        let v = document.getElementById("view");
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        
        // Xử lý nút active
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        } else {
            document.querySelector('.menu-item').classList.add('active');
        }

        if(p === 'trangchu') {
            v.innerHTML = `
                <h2>Bảng điều khiển</h2>
                <div class="money-card">
                    <h3>Số dư tài khoản</h3>
                    <div id="userMoney">Đang tải...</div>
                </div>
            `;
            if(currentEmail) loadMoneyData(currentEmail);
        } 
        else if(p === 'quydinh') {
            v.innerHTML = "<h2>Quy định</h2><p>Vui lòng tuân thủ các quy định để tránh bị khóa tài khoản.</p>";
        }
        else {
            v.innerHTML = "<h2>" + p.toUpperCase() + "</h2><p>Chức năng đang được cập nhật...</p>";
        }
    }

    function logout() {
        firebase.auth().signOut().then(() => {
            localStorage.removeItem("userEmail");
            window.location.href = "index.html";
        });
    }
</script>
</body>
</html>
