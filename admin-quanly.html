<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin - Duyệt Rút Tiền (Bảo mật)</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #e94560; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: center; font-size: 14px; }
        th { background: #e94560; color: white; }
        .btn-approve { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #access-denied { display: none; text-align: center; color: red; margin-top: 50px; }
    </style>
</head>
<body>

<div id="access-denied">
    <h1>QUYỀN TRUY CẬP BỊ TỪ CHỐI</h1>
    <p>Chỉ Admin mới có quyền truy cập trang này.</p>
</div>

<div id="admin-content" class="container" style="display: none;">
    <h2>Yêu cầu rút tiền chờ duyệt</h2>
    <div id="adminView">Đang tải dữ liệu...</div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBka80W-Aa9m4NXQ7PD4kmx1xew-lz67l0",
        authDomain: "fastraffic-8b585.firebaseapp.com",
        projectId: "fastraffic-8b585",
        databaseURL: "https://fastraffic-8b585-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Kiểm tra quyền Admin
    firebase.auth().onAuthStateChanged((user) => {
        if (user && user.email === 'nguyenthanhduy281009@gmail.com') {
            document.getElementById('admin-content').style.display = 'block';
            loadWithdrawRequests();
        } else {
            document.getElementById('access-denied').style.display = 'block';
        }
    });

    function loadWithdrawRequests() {
        db.ref('withdraw_requests').on('value', (s) => {
            let h = `<table><tr>
                <th>Thời gian</th>
                <th>Người dùng</th>
                <th>Số tiền</th>
                <th>Ngân hàng/Ví</th>
                <th>Số tài khoản</th>
                <th>Hành động</th>
            </tr>`;
            const data = s.val();
            if(!data) {
                h += `<tr><td colspan="6">Không có yêu cầu nào.</td></tr>`;
            } else {
                const keys = Object.keys(data).reverse();
                let hasPending = false;
                keys.forEach(id => {
                    const req = data[id];
                    if(req.status === 'pending') {
                        hasPending = true;
                        h += `<tr>
                            <td>${req.time}</td>
                            <td>${req.userId.replace(/_/g, '.')}</td>
                            <td style="color:red; font-weight:bold">${req.amount.toLocaleString()}đ</td>
                            <td>${req.bankName}</td>
                            <td><b>${req.bankAcc}</b></td>
                            <td><button class="btn-approve" onclick="approveWithdraw('${id}', '${req.userId}', ${req.amount})">Duyệt & Trừ tiền</button></td>
                        </tr>`;
                    }
                });
                if(!hasPending) h += `<tr><td colspan="6">Tất cả đã xử lý xong.</td></tr>`;
            }
            document.getElementById("adminView").innerHTML = h + `</table>`;
        });
    }

    function approveWithdraw(requestId, userId, amount) {
        if(confirm(`Xác nhận đã chuyển ${amount.toLocaleString()}đ? Hệ thống sẽ tự động trừ tiền ví user.`)) {
            // 1. Cập nhật trạng thái tổng
            db.ref('withdraw_requests/' + requestId).update({ status: 'completed' });
            // 2. Cập nhật lịch sử user
            db.ref('user_withdrawals/' + userId + '/' + requestId).update({ status: 'completed' });
            // 3. Trừ tiền ví user
            db.ref('users/' + userId + '/money').transaction((current) => {
                return (current || 0) - amount;
            });
            alert("Đã duyệt thành công!");
        }
    }
</script>
</body>
</html>
